name: Deploy Website

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deploy environment"
        required: true
        default: "preview"
        type: choice
        options:
          - preview
          - production

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  TZ: Asia/Tokyo

concurrency:
  group: "deploy-website"
  cancel-in-progress: false

jobs:
  define-environment:
    runs-on: ubuntu-slim
    outputs:
      environment: ${{ steps.define-environment.outputs.environment }}
    steps:
      - name: Define environment
        id: define-environment
        run: |
          environment=${{ inputs.environment }}
          if [ -z "$environment" ]; then
            environment=${{ github.event_name == 'push' && 'production' || 'preview' }}
          fi
          echo "Setting environment to $environment"
          echo "environment=$environment" >> $GITHUB_OUTPUT

  build-website:
    needs:
      - define-environment
    runs-on: ubuntu-24.04
    outputs:
      build_log: ${{ steps.build.outputs.LOG }}
    timeout-minutes: 5
    steps:
      # https://github.com/actions/checkout
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      # https://github.com/jdx/mise-action
      - name: Install Mise dependencies
        uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3.6.1
        with:
          install_args: "pnpm node"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build website
        run: pnpm run build

      - name: Deploy website (Preview)
        if: ${{ needs.define-environment.outputs.environment != 'production' }}
        id: deploy-preview
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          {
            echo "LOG<<EOL"
            pnpm wrangler versions upload 2>&1
            echo "EOL"
          } | tee -a $GITHUB_OUTPUT

      - name: Deploy website (Production)
        if: ${{ needs.define-environment.outputs.environment == 'production' }}
        id: deploy-production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          {
            echo "LOG<<EOL"
            pnpm wrangler deploy 2>&1
            echo "EOL"
          } | tee -a $GITHUB_OUTPUT

      - name: Extract deployment URL
        id: extract-deployment-url
        run: |
          if [ -z "${{ steps.deploy-preview.outputs.LOG }}" ]; then
            LOG="${{ steps.deploy-production.outputs.LOG }}"
          else
            LOG="${{ steps.deploy-preview.outputs.LOG }}"
          fi

          # `https://` „ÇíÂê´„ÇÄÊúÄÂàù„ÅÆË°å„Å†„Åë„ÇíÊäΩÂá∫„Åó„ÄÅDEPLOYMENT_URL„Å´Ê†ºÁ¥ç
          DEPLOYMENT_URL=$(echo "$LOG" | grep -o 'https://[^ ]*' | head -n 1)
          echo "DEPLOYMENT_URL=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT

      - name: Extract timestamp
        id: extract-timestamp
        env:
          TZ: Asia/Tokyo
        run: |
          echo "timestamp=$(date -Iseconds )" >> $GITHUB_OUTPUT

      - name: Extract logs
        id: extract-logs
        run: |
          echo "LOG<<EOF" >> $GITHUB_OUTPUT
          cat <<EOL | tee -a $GITHUB_OUTPUT
          ## üåçÔ∏è Website Preview Deployment
          üîóURL: ${{ steps.extract-deployment-url.outputs.DEPLOYMENT_URL }}

          üîëCommit Hash: \`${{ github.sha }}\`
          üìÖTimestamp: \`${{ steps.extract-timestamp.outputs.TIMESTAMP }}\`

          <details>
          <summary><h2>‚úàÔ∏è Deployment Logs</h2></summary>

          \`\`\`log
          ${{ steps.deploy-preview.outputs.LOG }}
          \`\`\`
          </details>
          EOL
          echo "EOF" >> $GITHUB_OUTPUT

      # https://github.com/thollander/actions-comment-pull-request
      - name: Comment PR with execution number
        uses: thollander/actions-comment-pull-request@24bffb9b452ba05a4f3f77933840a6a841d1b32b # v3.0.1
        if: ${{ github.event_name == 'pull_request' }}
        with:
          message: |
            ${{ steps.extract-logs.outputs.LOG }}
          comment-tag: deploy-website
